<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V√¨ An To√†n C·ªßa Tr·∫ª Em</title>
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Add Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCEt8H-NBPnssJLWEkhpSPHYb1vYH_A4is&libraries=visualization"></script>
    <link rel="stylesheet" href="/assest/css/style.css">
</head>
<style>
    .logo {
        margin-top: 7px;
        width: 50px; /* Adjust size as needed */
        height: 50px;
        margin-right: 10px; /* Space between logo and text */
        object-fit: contain; /* Ensure logo scales properly */
    }
</style>
<body>
    <div class="container">
        <header>
            <div class="search-actions"> 
                <img src="/assest/img/bg_app.png" alt="Logo" class="logo">
                <h1> H·ªá th·ªëng qu·∫£n l√Ω th√¥ng tin app SafeKid</h1>
            </div>
            <div class="search-actions">
                <button id="logout-btn" class="btn btn-secondary" style="background-color: rgb(247, 76, 76); color:#ffff;">ƒêƒÉng xu·∫•t</button>
                <button id="create-user-btn" class="btn btn-primary">+ T·∫°o t√†i kho·∫£n</button>
            </div>
        </header>

        <div class="search-tabs">
            <div class="search-tab " data-tab="admin-management">Qu·∫£n l√≠ Admin</div>
            <div class="search-tab" data-tab="staff-management">Qu·∫£n l√≠ Nh√¢n vi√™n</div>
            <div class="search-tab active" data-tab="app-data">Th√¥ng tin d·ªØ li·ªáu</div>
        </div>

        <!-- Admin Management -->
        <div class="search-container hidden" id="admin-management">
            <div class="search-header">
                <div class="search-title">Danh s√°ch Qu·∫£n tr·ªã vi√™n</div>
                <div class="search-actions">
                    <button class="btn btn-secondary" id="refresh-admin">L√†m m·ªõi</button>
                    <button class="btn btn-primary" id="search-admin">T√¨m ki·∫øm</button>
                </div>
            </div>

            <div class="search-fields">
                <div class="form-group">
                    <label for="admin-name">T√™n qu·∫£n tr·ªã vi√™n</label>
                    <input type="text" id="admin-name" placeholder="Nh·∫≠p t√™n...">
                </div>

                <div class="form-group">
                    <label for="admin-email">Email</label>
                    <input type="text" id="admin-email" placeholder="Nh·∫≠p email...">
                </div>

                <div class="form-group">
                    <label for="admin-status">Tr·∫°ng th√°i</label>
                    <select id="admin-status">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="active">Ho·∫°t ƒë·ªông</option>
                        <option value="inactive">Kh√¥ng ho·∫°t ƒë·ªông</option>
                    </select>
                </div>
            </div>

            <table class="results-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>H·ªç t√™n</th>
                        <th>Email</th>
                        <th>S·ªë ƒëi·ªán tho·∫°i</th>
                        <th>Ng√†y sinh</th>
                        <th>Gi·ªõi t√≠nh</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="admin-table-body">
                    <!-- Admin data will be loaded here -->
                </tbody>
            </table>

            <div class="pagination">
                <div class="page-item active">1</div>
                <div class="page-item">2</div>
                <div class="page-item">3</div>
                <div class="page-item">...</div>
                <div class="page-item">10</div>
            </div>
        </div>

        <!-- Staff Management -->
        <div class="search-container hidden" id="staff-management">
            <div class="search-header">
                <div class="search-title">Danh s√°ch Nh√¢n vi√™n</div>
                <div class="search-actions">
                    <button class="btn btn-secondary" id="refresh-staff">L√†m m·ªõi</button>
                    <button class="btn btn-primary" id="search-staff">T√¨m ki·∫øm</button>
                </div>
            </div>

            <div class="search-fields">
                <div class="form-group">
                    <label for="staff-name">T√™n nh√¢n vi√™n</label>
                    <input type="text" id="staff-name" placeholder="Nh·∫≠p t√™n...">
                </div>

                <div class="form-group">
                    <label for="staff-email">Email</label>
                    <input type="text" id="staff-email" placeholder="Nh·∫≠p email...">
                </div>

                <div class="form-group">
                    <label for="staff-status">Tr·∫°ng th√°i</label>
                    <select id="staff-status">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="pending">Ch·ªù ph√™ duy·ªát</option>
                        <option value="active">ƒê√£ ph√™ duy·ªát</option>
                        <option value="inactive">Kh√¥ng ho·∫°t ƒë·ªông</option>
                    </select>
                </div>
            </div>

            <table class="results-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>H·ªç t√™n</th>
                        <th>Email</th>
                        <th>S·ªë ƒëi·ªán tho·∫°i</th>
                        <th>Ng√†y sinh</th>
                        <th>Gi·ªõi t√≠nh</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="staff-table-body">
                    <!-- Staff data will be loaded here -->
                </tbody>
            </table>

            <div class="pagination">
                <div class="page-item active">1</div>
                <div class="page-item">2</div>
                <div class="page-item">3</div>
                <div class="page-item">...</div>
                <div class="page-item">10</div>
            </div>
        </div>

        <!-- App Data -->
        <div class="search-container " id="app-data">
            <div class="search-header">
                <div class="search-title">Th√¥ng tin d·ªØ li·ªáu theo d√µi t·ª´ thi·∫øt b·ªã</div>
                <button id="reset-data-btn" class="btn" style="background-color: aqua;  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">Reset th√¥ng tin</button>
            </div>

            <div class="health-data">
                <div class="health-card">
                    <h3>Th√¥ng tin nh·ªãp tim</h3>
                    <div>
                        <p>Nh·ªãp tim hi·ªán t·∫°i: <span id="heart-rate" class="heart-rate-value">--</span> bpm</p>
                        <p>T√¨nh tr·∫°ng: <span id="heart-status">Kh√¥ng c√≥ d·ªØ li·ªáu</span></p>
                        <canvas id="heart-rate-chart" height="200"></canvas>
                    </div>
                    
                </div>

                <div class="health-card">
                    <h3>Th√¥ng tin v·ªã tr√≠</h3>
                    <div>
                        <p>Vƒ© ƒë·ªô: <span id="latitude">--</span></p>
                        <p>Kinh ƒë·ªô: <span id="longitude">--</span></p>
                        <p>Th·ªùi gian d·ª´ng l·∫°i: <span id="location-time">--</span></p>
                        <p>Tr·∫°ng th√°i qu√™n tr·∫ª: <span id="forgot-status">--</span></p>
                        <p>ƒê·ªãa ch·ªâ: <span id="address">ƒêang t·∫£i...</span></p>
                    </div>
                </div>
            </div>

            <div id="map-container">
                <h3>B·∫£n ƒë·ªì v·ªã tr√≠</h3>
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Create/Edit User Modal -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">T·∫°o t√†i kho·∫£n m·ªõi</h3>
                <span class="close-modal">&times;</span>
            </div>
            <form id="user-form">
                <input type="hidden" id="user-id">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="full-name">H·ªç v√† t√™n *</label>
                            <input type="text" id="full-name" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" required>
                        </div>
                    </div>
                </div>

               <div class="form-row" id="password-fields">
                <div class="form-col">
                    <div class="form-group">
                        <label for="password">M·∫≠t kh·∫©u *</label>
                        <div class="password-wrapper">
                            <input type="password" id="password" required>
                            <span class="toggle-password" data-target="password">üëÅÔ∏è</span>
                        </div>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="confirm-password">X√°c nh·∫≠n m·∫≠t kh·∫©u *</label>
                        <div class="password-wrapper">
                            <input type="password" id="confirm-password" required>
                            <span class="toggle-password" data-target="confirm-password">üëÅÔ∏è</span>
                        </div>
                    </div>
                </div>
            </div>

                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="phone">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="tel" id="phone">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="birthdate">Ng√†y sinh</label>
                            <input type="date" id="birthdate">
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="gender">Gi·ªõi t√≠nh</label>
                            <select id="gender">
                                <option value="">Ch·ªçn gi·ªõi t√≠nh</option>
                                <option value="male">Nam</option>
                                <option value="female">N·ªØ</option>
                                <option value="other">Kh√°c</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="role">Vai tr√≤ *</label>
                            <select id="role" required>
                                <option value="">Ch·ªçn vai tr√≤</option>
                                <option value="admin">Qu·∫£n tr·ªã vi√™n</option>
                                <option value="staff">Nh√¢n vi√™n</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="address-input">ƒê·ªãa ch·ªâ</label>
                    <input type="text" id="address-input">
                </div>

                <div id="status-fields" class="form-row" style="display: none;">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="status">Tr·∫°ng th√°i</label>
                            <select id="status">
                                <option value="active">Ho·∫°t ƒë·ªông</option>
                                <option value="inactive">Kh√¥ng ho·∫°t ƒë·ªông</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="approved">Ph√™ duy·ªát</label>
                            <select id="approved">
                                <option value="true">ƒê√£ ph√™ duy·ªát</option>
                                <option value="false">Ch·ªù ph√™ duy·ªát</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="search-actions" style="justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary close-modal">H·ªßy</button>
                    <button type="submit" class="btn btn-primary" id="submit-btn">T·∫°o t√†i kho·∫£n</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Chart.js for heart rate visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>

        //  ki·ªÉm tra ƒëƒÉng nh·∫≠p 
         const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));

        if (!currentUser) {
            // Ch∆∞a ƒëƒÉng nh·∫≠p, chuy·ªÉn h∆∞·ªõng v·ªÅ trang ƒëƒÉng nh·∫≠p
            alert('Vui l√≤ng ƒëƒÉng nh·∫≠p');
            window.location.href = '/index.html';
        } else {
            alert(`Ch√†o m·ª´ng, ${currentUser.fullName}!`)
        }

        // H√†m ƒëƒÉng xu·∫•t
        function logout() {
            // X√≥a session
            sessionStorage.removeItem('currentUser');
            // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ƒëƒÉng nh·∫≠p
            window.location.href = 'index.html';
        }
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAMimu-AKBo-ISvXCS4wORyCfyHVwFi8D0",
            authDomain: "labln-fd4bb.firebaseapp.com",
            databaseURL: "https://labln-fd4bb-default-rtdb.firebaseio.com",
            projectId: "labln-fd4bb",
            storageBucket: "labln-fd4bb.appspot.com",
            messagingSenderId: "181646000819",
            appId: "1:181646000819:web:d97cbfb2a1b4e3dac066c6",
            measurementId: "G-V2ZG8EX96K"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // DOM elements
        const tabs = document.querySelectorAll('.search-tab');
        const containers = document.querySelectorAll('.search-container');
        const logoutBtn = document.getElementById('logout-btn');
        const createUserBtn = document.getElementById('create-user-btn');
        const resetdataBtn = document.getElementById('reset-data-btn')
        const userModal = document.getElementById('user-modal');
        const closeModalBtns = document.querySelectorAll('.close-modal');
        const userForm = document.getElementById('user-form');
        const modalTitle = document.getElementById('modal-title');
        const submitBtn = document.getElementById('submit-btn');
        const passwordFields = document.getElementById('password-fields');
        const statusFields = document.getElementById('status-fields');
        const userIdField = document.getElementById('user-id');

        // Bi·∫øn to√†n c·ª•c cho bi·ªÉu ƒë·ªì nh·ªãp tim
        let heartRateChart = null;
        let map = null;
        let marker = null;

        // Tab switching functionality
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs
                tabs.forEach(t => t.classList.remove('active'));
                // Add active class to clicked tab
                tab.classList.add('active');

                // Hide all search containers
                containers.forEach(container => {
                    container.classList.add('hidden');
                });

                // Show the selected search container
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(tabId).classList.remove('hidden');
                // Load data based on tab
                if (tabId === 'admin-management') {
                    loadAdminUsers();
                } else if (tabId === 'staff-management') {
                    loadStaffUsers();
                } else if (tabId === 'app-data') {
                    loadAppData();
                }
            });
        });

        // Modal functionality
        createUserBtn.addEventListener('click', () => {
            // Reset form and show password fields for new user
            userForm.reset();
            modalTitle.textContent = 'T·∫°o t√†i kho·∫£n m·ªõi';
            submitBtn.textContent = 'T·∫°o t√†i kho·∫£n';
            passwordFields.style.display = 'flex';
            statusFields.style.display = 'none';
            userIdField.value = '';
            userModal.style.display = 'block';
        });

        closeModalBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                userModal.style.display = 'none';
            });
        });

        // window.addEventListener('click', (e) => {
        //     if (e.target === userModal) {
        //         userModal.style.display = 'none';
        //     }
        // });

        logoutBtn.addEventListener('click',()=>{
            logout()
            //  window.location.href = '/index.html';
        })
       
        // Form submission for creating/updating user
     userForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const userId = userIdField.value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const fullName = document.getElementById('full-name').value;
        const phone = document.getElementById('phone').value;
        const birthdate = document.getElementById('birthdate').value;
        const gender = document.getElementById('gender').value;
        const role = document.getElementById('role').value;
        const address = document.getElementById('address-input').value;
        const status = document.getElementById('status').value;
        const approved = document.getElementById('approved').value === 'true';

        // Validate password n·∫øu l√† t·∫°o m·ªõi
        if (password !== confirmPassword) {
            alert('M·∫≠t kh·∫©u kh√¥ng kh·ªõp!');
            return;
        }

        try {
            // Check if email already exists (except for the current user if updating)
            const snapshot = await database.ref('users').once('value');
            const users = snapshot.val();

            if (users) {
                let emailExists = false;
                Object.keys(users).forEach((key) => {
                    if (users[key].email === email && key !== userId) {
                        emailExists = true;
                    }
                });

                if (emailExists) {
                    alert('T√†i kho·∫£n v·ªõi email n√†y ƒë√£ t·ªìn t·∫°i!');
                    return;
                }
            }

            const userData = {
                fullName,
                email,
                phone,
                birthdate,
                gender,
                role,
                address,
                status,
                approved,
                updatedAt: Date.now()
            };

            if (!role) {
                alert("Vui l√≤ng ch·ªçn vai tr√≤ (role)!");
                return;
            }

            if (userId) {
                await database.ref('users/' + userId).update(userData);
                userModal.style.display = 'none';
                alert("C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng th√†nh c√¥ng");
            } else {
                try {
                    const newUserRef = database.ref('users').push();
                    const newUserId = newUserRef.key;
                    userData.password = password;
                    userData.createdAt = Date.now();
                    userData.status = 'active';
                    userData.approved = role === 'admin';

                    await newUserRef.set(userData);
                    userModal.style.display = 'none';
                    alert('T·∫°o t√†i kho·∫£n th√†nh c√¥ng!');
                } catch (error) {
                    console.error('L·ªói t·∫°o t√†i kho·∫£n:', error);
                    alert('T·∫°o t√†i kho·∫£n th·∫•t b·∫°i!');
                }
            }

            const activeTab = document.querySelector('.search-tab.active').getAttribute('data-tab');
            if (activeTab === 'admin-management') {
                loadAdminUsers();
            } else if (activeTab === 'staff-management') {
                loadStaffUsers();
            }
        } catch (error) {
            console.error('L·ªói khi l∆∞u user:', error);
            alert('L·ªói: ' + error.message);
        }
    });

    //  xem m·∫≠t kh·∫©u
    document.addEventListener("DOMContentLoaded", function() {
        const toggleButtons = document.querySelectorAll(".toggle-password");
        
        toggleButtons.forEach(button => {
            button.addEventListener("click", function() {
                const targetId = this.getAttribute("data-target");
                const input = document.getElementById(targetId);
                const type = input.getAttribute("type") === "password" ? "text" : "password";
                input.setAttribute("type", type);
                // Optionally toggle the icon (e.g., üëÅÔ∏è to üëÅÔ∏è‚Äçüó®Ô∏è for hide), but using the same emoji for simplicity
            });
        });
    });

        //  Reset data app 
        resetdataBtn.addEventListener('click', async()=>{
            await database.ref('NhipTim/').set(85);
            await database.ref('forgot_status/').set(0);
            await database.ref('ToaDo/').set({
                lat: 16.077688,           
                long: 108.2139,          
                timestamp: Date.now(), 
            });
            alert('Reset th√¥ng tin th√†nh c√¥ng!');

        })

        // Load admin users
        async function loadAdminUsers() {
            const adminTableBody = document.getElementById('admin-table-body');
            adminTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

            try {
                const snapshot = await database.ref('users').orderByChild('role').equalTo('admin').once('value');
                const users = snapshot.val();

                adminTableBody.innerHTML = '';

                if (!users) {
                    adminTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                    return;
                }

                let count = 1;
                Object.keys(users).forEach(userId => {
                    const user = users[userId];
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${count++}</td>
                        <td>${user.fullName || '--'}</td>
                        <td>${user.email}</td>
                        <td>${user.phone || '--'}</td>
                        <td>${user.birthdate ? new Date(user.birthdate).toLocaleDateString() : '--'}</td>
                        <td>${getGenderText(user.gender)}</td>
                        <td><span class="status ${user.status === 'active' ? 'status-active' : 'status-inactive'}">${user.status === 'active' ? 'Ho·∫°t ƒë·ªông' : 'Kh√¥ng ho·∫°t ƒë·ªông'}</span></td>
                        <td class="action-buttons">
                            <button class="btn btn-edit" data-id="${userId}">S·ª≠a</button>
                            <button class="btn ${user.status === 'active' ? 'btn-lock' : 'btn-approve'}" data-id="${userId}">${user.status === 'active' ? 'Kh√≥a' : 'M·ªü'}</button>
                            <button class="btn btn-delete" data-id="${userId}">X√≥a</button>
                        </td>
                    `;
                    
                    adminTableBody.appendChild(row);
                });

                // Add event listeners for buttons
                addUserActionListeners();
            } catch (error) {
                console.error('Error loading admin users:', error);
                adminTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>';
            }
        }

        // Load staff users
        async function loadStaffUsers() {
            const staffTableBody = document.getElementById('staff-table-body');
            staffTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

            try {
                const snapshot = await database.ref('users').orderByChild('role').equalTo('staff').once('value');
                const users = snapshot.val();

                staffTableBody.innerHTML = '';

                if (!users) {
                    staffTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                    return;
                }

                let count = 1;
                Object.keys(users).forEach(userId => {
                    const user = users[userId];
                    const row = document.createElement('tr');
                    
                    let statusClass = 'status-pending';
                    let statusText = 'Ch·ªù ph√™ duy·ªát';
                    
                    if (user.approved) {
                        statusClass = user.status === 'active' ? 'status-active' : 'status-inactive';
                        statusText = user.status === 'active' ? 'Ho·∫°t ƒë·ªông' : 'Kh√¥ng ho·∫°t ƒë·ªông';
                    }
                    
                    row.innerHTML = `
                        <td>${count++}</td>
                        <td>${user.fullName || '--'}</td>
                        <td>${user.email}</td>
                        <td>${user.phone || '--'}</td>
                        <td>${user.birthdate ? new Date(user.birthdate).toLocaleDateString() : '--'}</td>
                        <td>${getGenderText(user.gender)}</td>
                        <td><span class="status ${statusClass}">${statusText}</span></td>
                        <td class="action-buttons">
                            ${!user.approved ? `<button class="btn btn-approve" data-id="${userId}">Ph√™ duy·ªát</button>` : ''}
                            <button class="btn btn-edit" data-id="${userId}">S·ª≠a</button>
                            <button class="btn ${user.status === 'active' ? 'btn-lock' : 'btn-approve'}" data-id="${userId}">${user.status === 'active' ? 'Kh√≥a' : 'M·ªü'}</button>
                            <button class="btn btn-delete" data-id="${userId}">X√≥a</button>
                        </td>
                    `;
                    
                    staffTableBody.appendChild(row);
                });

                // Add event listeners for buttons
                addUserActionListeners();
            } catch (error) {
                console.error('Error loading staff users:', error);
                staffTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>';
            }
        }

        // Add event listeners for user action buttons
        function addUserActionListeners() {
            // Edit buttons
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const userId = e.target.getAttribute('data-id');
                    try {
                        const snapshot = await database.ref('users/' + userId).once('value');
                        const user = snapshot.val();
                        
                        if (user) {
                            // Fill the form with user data
                            document.getElementById('full-name').value = user.fullName || '';
                            document.getElementById('email').value = user.email || '';
                            document.getElementById('phone').value = user.phone || '';
                            document.getElementById('birthdate').value = user.birthdate || '';
                            document.getElementById('gender').value = user.gender || '';
                            document.getElementById('password').value = user.password||'';
                            document.getElementById('confirm-password').value = user.password||'';
                            document.getElementById('role').value = user.role || '';
                            document.getElementById('address-input').value = user.address || '';
                            document.getElementById('status').value = user.status || 'active';
                            document.getElementById('approved').value = user.approved ? 'true' : 'false';
                            
                            // Update modal for editing
                            modalTitle.textContent = 'Ch·ªânh s·ª≠a t√†i kho·∫£n';
                            submitBtn.textContent = 'C·∫≠p nh·∫≠t';
                            // passwordFields.style.display = 'none';
                          
                            statusFields.style.display = 'flex';
                            userIdField.value = userId;
                            
                            userModal.style.display = 'block';
                        }
                    } catch (error) {
                        console.error('Error loading user data:', error);
                        alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ng∆∞·ªùi d√πng');
                    }
                });
            });

            // Approve buttons
            document.querySelectorAll('.btn-approve').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const userId = e.target.getAttribute('data-id');
                    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ph√™ duy·ªát nh√¢n vi√™n n√†y?')) {
                        try {
                            await database.ref('users/' + userId).update({
                                approved: true,
                                status: 'active',
                                updatedAt: Date.now()
                            });
                            alert('Ph√™ duy·ªát nh√¢n vi√™n th√†nh c√¥ng!');
                            
                            // Reload the appropriate list
                            const activeTab = document.querySelector('.search-tab.active').getAttribute('data-tab');
                            if (activeTab === 'admin-management') {
                                loadAdminUsers();
                            } else if (activeTab === 'staff-management') {
                                loadStaffUsers();
                            }
                        } catch (error) {
                            console.error('Error approving staff:', error);   
                            alert('Ph√™ duy·ªát kh√¥ng th√†nh c√¥ng: ' + error.message);
                        }
                    }
                });
            });

            // Lock/Unlock buttons
            document.querySelectorAll('.btn-lock, .btn-approve:not(.btn-approve[data-id])').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('btn-approve') && e.target.textContent === 'Ph√™ duy·ªát') return;
                    
                    const userId = e.target.getAttribute('data-id');
                    const currentStatus = e.target.classList.contains('btn-lock') ? 'active' : 'inactive';
                    const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
                    const action = currentStatus === 'active' ? 'kh√≥a' : 'm·ªü';
                    
                    if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ${action} t√†i kho·∫£n n√†y?`)) {
                        try {
                            await database.ref('users/' + userId).update({
                                status: newStatus,
                                updatedAt: Date.now()
                            });
                            alert(`${action === 'kh√≥a' ? 'Kh√≥a' : 'M·ªü'} t√†i kho·∫£n th√†nh c√¥ng!`);
                            
                            // Reload the appropriate list
                            const activeTab = document.querySelector('.search-tab.active').getAttribute('data-tab');
                            if (activeTab === 'admin-management') {
                                loadAdminUsers();
                            } else if (activeTab === 'staff-management') {
                                loadStaffUsers();
                            }
                        } catch (error) {
                            console.error(`Error ${action} user:`, error);
                            alert(`${action === 'kh√≥a' ? 'Kh√≥a' : 'M·ªü'} t√†i kho·∫£n kh√¥ng th√†nh c√¥ng: ${error.message}`);
                        }
                    }
                });
            });

            // Delete buttons
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const userId = e.target.getAttribute('data-id');
                    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i kho·∫£n n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
                        try {
                            // // Delete from Authentication
                            // await auth.currentUser.delete();
                            
                            // Delete from Realtime Database
                            await database.ref('users/' + userId).remove();
                            
                            alert('X√≥a t√†i kho·∫£n th√†nh c√¥ng!');
                            
                            // Reload the appropriate list
                            const activeTab = document.querySelector('.search-tab.active').getAttribute('data-tab');
                            if (activeTab === 'admin-management') {
                                loadAdminUsers();
                            } else if (activeTab === 'staff-management') {
                                loadStaffUsers();
                            }
                        } catch (error) {
                            console.error('Error deleting user:', error);
                            alert('X√≥a t√†i kho·∫£n kh√¥ng th√†nh c√¥ng: ' + error.message);
                        }
                    }
                });
            });
        }

        // Helper function to get gender text
        function getGenderText(gender) {
            switch (gender) {
                case 'male': return 'Nam';
                case 'female': return 'N·ªØ';
                case 'other': return 'Kh√°c';
                default: return '--';
            }
        }

        // Load app data (heart rate and location)
        function loadAppData() {
            // Load heart rate data
            database.ref('NhipTim').on('value', (snapshot) => {
                const heartRate = snapshot.val();
                if (heartRate) {
                    document.getElementById('heart-rate').textContent = heartRate;
                    
                    const heartStatus = document.getElementById('heart-status');
                    if (heartRate < 60) {
                        heartStatus.textContent = 'Nh·ªãp tim th·∫•p';
                        heartStatus.style.color = 'var(--warning-color)';
                    } else if (heartRate > 100) {
                        heartStatus.textContent = 'Nh·ªãp tim cao';
                        heartStatus.style.color = 'var(--danger-color)';
                    } else {
                        heartStatus.textContent = 'B√¨nh th∆∞·ªùng';
                        heartStatus.style.color = 'var(--success-color)';
                    }
                    
                    // Update chart if it exists
                    if (heartRateChart) {
                        updateHeartRateChart(heartRate);
                    }
                }
            });

            // Load location data
            database.ref('ToaDo').on('value', (snapshot) => {
                const locationData = snapshot.val();
                if (locationData) {
                    const lat = locationData.lat;
                    const lng = locationData.long;
                    const timestamp = locationData.timestamp;
                    const forgotStatus = locationData.forgot_status;
                    //  chuy·ªÉn ƒë·ªïi time 
                    const now = Date.now(); // th·ªùi gian hi·ªán t·∫°i (mili gi√¢y)

                    // T√≠nh kho·∫£ng th·ªùi gian d·ª´ng (mili gi√¢y)
                    const diffMs = now - timestamp;

                    // Chuy·ªÉn kho·∫£ng th·ªùi gian sang ƒë∆°n v·ªã d·ªÖ hi·ªÉu (v√≠ d·ª•: gi√¢y, ph√∫t, gi·ªù)
                    const diffSeconds = Math.floor(diffMs / 1000);
                    const diffMinutes = Math.floor(diffSeconds / 60);
                    const diffHours = Math.floor(diffMinutes / 60); 

                    document.getElementById('latitude').textContent = lat;
                    document.getElementById('longitude').textContent = lng;
                   document.getElementById('location-time').textContent = `${diffHours} gi·ªù, ${diffMinutes % 60} ph√∫t, ${diffSeconds % 60} gi√¢y`;
                    document.getElementById('forgot-status').textContent = forgotStatus === 1 ? 'Ph√°t hi·ªán b·ªè qu√™n tr·∫ª tr√™n xe' : 'B√¨nh th∆∞·ªùng - H·ªá th·ªëng an to√†n';
                    document.getElementById('forgot-status').style.color = forgotStatus === 1 ? 'var(--danger-color)' : 'var(--success-color)';
                    
                    // Update map
                    updateMap(lat, lng);
                    
                    // Reverse geocode to get address (simplified for demo)
                    getAddressFromLatLng(lat, lng);
                }
            });

            // Initialize heart rate chart
            initHeartRateChart();
        }

        // Initialize heart rate chart
        function initHeartRateChart() {
            const ctx = document.getElementById('heart-rate-chart').getContext('2d');
            
            // Create initial empty chart
            heartRateChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Nh·ªãp tim (bpm)',
                        data: [],
                        borderColor: 'var(--danger-color)',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false,
                            suggestedMin: 50,
                            suggestedMax: 120
                        }
                    }
                }
            });
        }

        // Update heart rate chart with new data
        function updateHeartRateChart(newRate) {
            // Get current data
            const labels = heartRateChart.data.labels;
            const data = heartRateChart.data.datasets[0].data;
            
            // Add new data point
            const now = new Date();
            const timeString = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            labels.push(timeString);
            data.push(newRate);
            
            // Keep only the last 20 data points
            if (labels.length > 20) {
                labels.shift();
                data.shift();
            }
            
            // Update chart
            heartRateChart.update();
        }

        // Initialize map
        function initMap(lat = 16.077688, lng = 108.2139) {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat, lng },
                zoom: 15,
                mapTypeId: 'roadmap'
            });
            
            marker = new google.maps.Marker({
                position: { lat, lng },
                map: map,
                title: 'V·ªã tr√≠ hi·ªán t·∫°i'
            });
        }

        // Update map with new location
        function updateMap(lat, lng) {
            if (!map) {
                initMap(lat, lng);
                return;
            }
            
            const newPos = new google.maps.LatLng(lat, lng);
            map.setCenter(newPos);
            
            if (marker) {
                marker.setPosition(newPos);
            } else {
                marker = new google.maps.Marker({
                    position: newPos,
                    map: map,
                    title: 'V·ªã tr√≠ hi·ªán t·∫°i'
                });
            }
        }

       function getAddressFromLatLng(lat, lng) {
            const apiKey = 'ea03da5c24284ccb85670fb976d6b4e5'; // Thay b·∫±ng API key th·∫≠t c·ªßa b·∫°n
            const url = `https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lng}&key=${apiKey}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.results && data.results.length > 0) {
                        const address = data.results[0].formatted;
                        document.getElementById('address').textContent = address;
                    } else {
                        document.getElementById('address').textContent = 'Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ';
                    }
                })
                .catch(error => {
                    console.error('L·ªói khi g·ªçi API OpenCage:', error);
                    document.getElementById('address').textContent = 'L·ªói l·∫•y ƒë·ªãa ch·ªâ';
                });
        }


        // Refresh buttons
        document.getElementById('refresh-admin').addEventListener('click', loadAdminUsers);
        document.getElementById('refresh-staff').addEventListener('click', loadStaffUsers);

        // Search buttons (simplified for demo)
        document.getElementById('search-admin').addEventListener('click', () => {
            alert('Ch·ª©c nƒÉng t√¨m ki·∫øm s·∫Ω ƒë∆∞·ª£c tri·ªÉn khai sau');
        });

        document.getElementById('search-staff').addEventListener('click', () => {
            alert('Ch·ª©c nƒÉng t√¨m ki·∫øm s·∫Ω ƒë∆∞·ª£c tri·ªÉn khai sau');
        });

    </script>
    <script>
        // loadAdminUsers();
        loadAppData();
    </script>
</body>
</html>